name: Code coverage
on:
  workflow_dispatch:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: read-all

jobs:
  Coverage:
    runs-on: ${{ matrix.config.os }}
    env:
      CMAKE_BUILD_TYPE: 'Release'
    strategy:
      fail-fast: false
      matrix:
        config:
          - { name: "Ubuntu-gcc", os: ubuntu-latest-16-cores, cc: "gcc", cxx: "g++" }

    steps:
      - name: Setup python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.10.10'
          architecture: 'x64'


      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@5ebbd400eff9e74630f759d94ddd7b6c26299639 # v1.2.20
        with:
          max-size: 50G

      - name: Clone OpenVINO
        uses: ababushk/checkout@9bec46a94a83db82acd4303e7627d88db71402a5 # cherry_pick_retries
        timeout-minutes: 15
        with:
          submodules: 'true'

      - name: Install dependencies
        run: |
          sudo apt --assume-yes update
          sudo -E ${{ github.workspace }}/install_build_dependencies.sh
          sudo apt --assume-yes install lcov

          python3 -m pip install --upgrade pip
          python3 -m pip install -r ${{ github.workspace }}/src/bindings/python/wheel/requirements-dev.txt
          # For running Paddle frontend unit tests
          python3 -m pip install -r ${{ github.workspace }}/src/frontends/paddle/tests/requirements.txt
          # For running ONNX frontend unit tests
          python3 -m pip install -r ${{ github.workspace }}/src/frontends/onnx/tests/requirements.txt
          # For running TensorFlow frontend unit tests
          python3 -m pip install -r ${{ github.workspace }}/src/frontends/tensorflow/tests/requirements.txt
          # For running TensorFlow Lite frontend unit tests
          python3 -m pip install -r ${{ github.workspace }}/src/frontends/tensorflow_lite/tests/requirements.txt

      - name: Build OpenVINO with CMake
        uses: ashutoshvarma/action-cmake-build@ade188313bc7eaa6f14349569a64d8bc716342ff # master
        with:
          build-dir: ${{ github.workspace }}/build
          cc: ${{ matrix.config.cc }}
          cxx: ${{ matrix.config.cxx }}
          configure-options: >
            -GNinja
            -DCMAKE_VERBOSE_MAKEFILE=ON
            -DENABLE_PYTHON=ON
            -DENABLE_ONEDNN_FOR_GPU=ON
            -DENABLE_TESTS=ON
            -DENABLE_FUNCTIONAL_TESTS=ON
            -DENABLE_OV_ONNX_FRONTEND=ON
            -DENABLE_OV_PADDLE_FRONTEND=ON
            -DENABLE_OV_TF_FRONTEND=ON
            -DENABLE_OV_TF_LITE_FRONTEND=ON
            -DENABLE_INTEL_NPU=OFF
            -DENABLE_STRICT_DEPENDENCIES=OFF
            -DENABLE_COVERAGE=ON
            -DCMAKE_C_COMPILER_LAUNCHER=ccache
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
            -DCMAKE_C_LINKER_LAUNCHER=ccache
            -DCMAKE_CXX_LINKER_LAUNCHER=ccache
            -DENABLE_SYSTEM_SNAPPY=ON
          build-type: ${{ env.CMAKE_BUILD_TYPE }}

      - name: Install wheel packages
        run: cmake -DCOMPONENT=python_wheels -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install_pkg -P '${{ github.workspace }}/build/cmake_install.cmake'

      - name: List binaries
        run: ls -la ${{ github.workspace }}/bin/intel64/${{ env.CMAKE_BUILD_TYPE }}

      - name: Install OpenVINO
        run: cmake -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install_pkg -P '${{ github.workspace }}/build/cmake_install.cmake'

      - name: Run selected coverage tests
        run: |
          set +e

          BIN_DIR="${{ github.workspace }}/bin/intel64/${{ env.CMAKE_BUILD_TYPE }}"
          MODEL_PATH="${{ github.workspace }}/src/core/tests/models/ir/add_abc.xml"
          FAILED_TESTS=()
          SKIPPED_TESTS=()

          run_binary() {
            local test_name="$1"
            local binary_name="$2"
            shift 2

            local exe_path="${BIN_DIR}/${binary_name}"
            if [[ ! -x "${exe_path}" ]]; then
              SKIPPED_TESTS+=("${test_name} (missing binary: ${binary_name})")
              return 0
            fi

            echo "========== Running ${test_name} =========="
            "${exe_path}" "$@"
            local rc=$?
            if [[ ${rc} -ne 0 ]]; then
              FAILED_TESTS+=("${test_name} (exit ${rc})")
            fi
          }

          # Unsupported in this workflow:
          # - ov_npu_func_tests, ov_npu_unit_tests require NPU-specific environment/driver stability.
          # - ov_nvidia_func_tests requires openvino_contrib NVIDIA plugin build and NVIDIA runner.
          SKIPPED_TESTS+=("ov_npu_func_tests (unsupported in coverage workflow)")
          SKIPPED_TESTS+=("ov_npu_unit_tests (unsupported in coverage workflow)")
          SKIPPED_TESTS+=("ov_nvidia_func_tests (unsupported in coverage workflow)")

          run_binary "ov_api_conformance_tests" "ov_api_conformance_tests" "--gtest_filter=*mandatory*"
          run_binary "ov_auto_batch_func_tests" "ov_auto_batch_func_tests" "--gtest_filter=*smoke*"
          run_binary "ov_auto_batch_unit_tests" "ov_auto_batch_unit_tests"
          run_binary "ov_auto_func_tests" "ov_auto_func_tests" "--gtest_filter=*smoke*"
          run_binary "ov_auto_unit_tests" "ov_auto_unit_tests"
          run_binary "ov_capi_test" "ov_capi_test"
          run_binary "ov_conditional_compilation_tests" "ov_conditional_compilation_tests"
          run_binary "ov_core_unit_tests" "ov_core_unit_tests" "--gtest_filter=-*IE_GPU*"
          run_binary "ov_cpu_func_tests" "ov_cpu_func_tests" "--gtest_filter=*smoke*"
          run_binary "ov_cpu_unit_tests" "ov_cpu_unit_tests"
          run_binary "ov_cpu_unit_tests_vectorized" "ov_cpu_unit_tests_vectorized"
          run_binary "ov_hetero_func_tests" "ov_hetero_func_tests" "--gtest_filter=*smoke*:-nightly*"
          run_binary "ov_hetero_unit_tests" "ov_hetero_unit_tests"
          run_binary "ov_inference_functional_tests" "ov_inference_functional_tests"
          run_binary "ov_inference_unit_tests" "ov_inference_unit_tests"
          run_binary "ov_ir_frontend_tests" "ov_ir_frontend_tests"
          run_binary "ov_lp_transformations_tests" "ov_lp_transformations_tests"
          run_binary "ov_onnx_frontend_tests" "ov_onnx_frontend_tests" "--gtest_filter=-*IE_GPU*"
          run_binary "ov_op_conformance_tests" "ov_op_conformance_tests" "--device=TEMPLATE" "--gtest_filter=*OpImpl*"
          run_binary "ov_proxy_plugin_tests" "ov_proxy_plugin_tests"
          run_binary "ov_snippets_func_tests" "ov_snippets_func_tests"
          run_binary "ov_subgraphs_dumper_tests" "ov_subgraphs_dumper_tests"
          run_binary "ov_template_func_tests" "ov_template_func_tests" "--gtest_filter=*smoke*"
          run_binary "ov_tensorflow_common_tests" "ov_tensorflow_common_tests"
          run_binary "ov_tensorflow_frontend_tests" "ov_tensorflow_frontend_tests" "--gtest_filter=-*IE_GPU*"
          run_binary "ov_tensorflow_lite_frontend_tests" "ov_tensorflow_lite_frontend_tests"
          run_binary "ov_transformations_tests" "ov_transformations_tests"
          run_binary "ov_util_tests" "ov_util_tests"
          run_binary "paddle_tests" "paddle_tests"
          run_binary "test_inference_async" "test_inference_async" "${MODEL_PATH}" "CPU"
          run_binary "test_inference_sync" "test_inference_sync" "${MODEL_PATH}" "CPU"

          {
            echo "## Coverage test execution summary"
            echo ""
            if [[ ${#FAILED_TESTS[@]} -gt 0 ]]; then
              echo "Failed tests:"
              for item in "${FAILED_TESTS[@]}"; do
                echo "- ${item}"
              done
            else
              echo "Failed tests: none"
            fi
            echo ""
            if [[ ${#SKIPPED_TESTS[@]} -gt 0 ]]; then
              echo "Skipped tests:"
              for item in "${SKIPPED_TESTS[@]}"; do
                echo "- ${item}"
              done
            else
              echo "Skipped tests: none"
            fi
          } >> "${GITHUB_STEP_SUMMARY}"

          if [[ ${#FAILED_TESTS[@]} -gt 0 ]]; then
            echo "One or more tests failed; continuing to coverage generation."
          fi

      - name: Print info
        run: |
          ls -laR
          pwd

      - name: Generate raport
        run: |
          set -euo pipefail

          SRC_DIR="${{ github.workspace }}"
          BUILD_DIR="${{ github.workspace }}/build"
          REPORT_DIR="${{ github.workspace }}/coverage-report"

          echo "Capturing coverage from $BUILD_DIR (base=$SRC_DIR)..."
          lcov --capture \
               --directory "$BUILD_DIR" \
               --base-directory "$SRC_DIR" \
               --output-file coverage.info \
               --no-external \
               --rc geninfo_unexecuted_blocks=1 \
               --ignore-errors mismatch,negative,unused

          echo "Applying exclude patterns (tests, thirdparty, protobuf generated)..."
          lcov --remove coverage.info \
               "${SRC_DIR}/*.pb.cc" \
               "${SRC_DIR}/*.pb.h" \
               "${SRC_DIR}/*/tests/*" \
               "${SRC_DIR}/thirdparty/*" \
               -o coverage.info

          mkdir -p "$REPORT_DIR"
          genhtml coverage.info \
                  --output-directory "$REPORT_DIR" \
                  --prefix "$SRC_DIR" \
                  --synthesize-missing

      - name: Coverage summary
        run: |
          echo "## Code coverage (lcov)" >> "$GITHUB_STEP_SUMMARY"
          if [ -f coverage.info ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            lcov --summary coverage.info >> "$GITHUB_STEP_SUMMARY" || true
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "coverage.info not found (coverage generation likely failed earlier)." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Package coverage report
        run: |
          set -euo pipefail
          if [ -d "${{ github.workspace }}/coverage-report" ] && [ -f coverage.info ]; then
            tar -czf coverage-report.tgz coverage-report coverage.info
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Artifact: \`coverage-report.tgz\` (download from Actions → Artifacts, then extract and open \`coverage-report/index.html\`)." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "coverage-report/ or coverage.info missing → skipping artifact packaging." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: coverage-report-${{ matrix.config.name }}
          path: coverage-report.tgz
          if-no-files-found: warn
          retention-days: 30
          compression-level: 0

      - name: Collect coverage
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          verbose: true
